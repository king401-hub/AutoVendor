{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <h2 class="text-center mb-4">Live Help Chat</h2>

  <div id="chat-box" 
       class="p-3 mb-3 rounded shadow-sm"
       style="background:#f8f9fa; border:1px solid #ddd; height:400px; overflow-y:auto;">
  </div>

  <div class="input-group">
    <input type="text" id="user-input" class="form-control" placeholder="Type your message...">
    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
  </div>
</div>

<style>
/* Chat bubble styling */
.message {
  max-width: 75%;
  padding: 10px 15px;
  margin: 8px 0;
  border-radius: 18px;
  font-size: 15px;
  line-height: 1.4;
}

.user-msg {
  background: #0d6efd;
  color: white;
  margin-left: auto;
  border-bottom-right-radius: 5px;
  text-align: right;
}

.bot-msg {
  background: #e9ecef;
  color: #333;
  margin-right: auto;
  border-bottom-left-radius: 5px;
}

.timestamp {
  display: block;
  font-size: 11px;
  margin-top: 3px;
  opacity: 0.7;
}
</style>

<script>
function formatTime() {
  const now = new Date();
  return now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function sendMessage() {
  const message = document.getElementById("user-input").value.trim();
  if (!message) return;

  const chatBox = document.getElementById("chat-box");

  // Show user bubble
  chatBox.innerHTML += `
    <div class="message user-msg">
      ${message}
      <span class="timestamp">${formatTime()}</span>
    </div>
  `;

  // Create bot bubble placeholder
  const botBubble = document.createElement("div");
  botBubble.className = "message bot-msg";
  botBubble.innerHTML = `<span class="text"></span>
    <span class="timestamp">${formatTime()}</span>`;
  chatBox.appendChild(botBubble);

  const botText = botBubble.querySelector(".text");
  chatBox.scrollTop = chatBox.scrollHeight;

  // Stream bot response
  const evtSource = new EventSourcePolyfill("/chat/stream/", {
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "message": message
    }
  });

  evtSource.onmessage = function(event) {
    botText.textContent += event.data; // add words as they come
    chatBox.scrollTop = chatBox.scrollHeight;
  };

  evtSource.onerror = function() {
    evtSource.close();
  };

  document.getElementById("user-input").value = "";
}
</script>
{% endblock %}
